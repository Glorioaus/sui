# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 提供在本仓库中工作的指导。

## 常用开发命令

### 安装依赖
```bash
pip install -r requirements.txt
```

### 处理单个文件
```bash
python src/main.py <输入文件> [输出目录]
```
示例：
```bash
python src/main.py input/建行信用卡.csv output/
```

### 批量处理目录
```bash
python src/main.py <输入目录> <输出目录>
```
示例：
```bash
python src/main.py input/ output/
```

### 合并处理（跨文件退款对冲 + 转账识别）
```bash
python src/merge.py <输出目录> [合并文件名]
```
示例：
```bash
python src/merge.py output/
# → 生成 output/merged_账单.xlsx
```

### 完整两阶段处理流程
```bash
# 第一阶段：解析各银行账单，生成独立Excel
python src/main.py input/ output/

# 第二阶段：合并处理，执行跨文件退款对冲和转账识别
python src/merge.py output/
```

## 文件命名规则

解析器通过文件名自动识别银行类型：

| 文件名模式 | 解析器 | 说明 |
|-----------|--------|------|
| `农行*.pdf` | ABCParser | 农业银行储蓄卡 |
| `浦发*.pdf` | SPDBParser | 浦发信用卡 |
| `招商*.pdf` | CMBParser | 招商信用卡 |
| `*账单*.pdf` | SPDBParser | 浦发信用卡（账单格式）|
| `中信*.pdf` | CITICParser | 中信银行 |
| `建行信用卡*.pdf` | CCBCreditParser | 建行信用卡 |
| `建行*.csv` | CCBParser | 建设银行储蓄卡 |
| `宁波*.xlsx` | BOCParser | 宁波银行 |
| `微信*.xlsx` | WeChatParser | 微信支付 |
| `支付宝*.csv` | AlipayParser | 支付宝 |

## 高层代码架构

### 概述
这是一个银行账单格式转换工具，可将多种银行账单格式（CSV、Excel、PDF）转换为兼容随手记个人理财应用的标准化Excel格式。

### 核心组件

1. **主入口**: `src/main.py`
   - 处理命令行参数
   - 根据文件类型路由到合适的解析器
   - 支持单个文件或批量目录处理

2. **解析器架构**:
   - 抽象基类: `src/base_parser.py`（提供通用工具，如日期解析、金额解析、分类匹配）
   - 银行专用解析器位于 `src/parsers/`:
     - `CCBParser`: 建设银行储蓄卡 (CSV格式)
     - `CCBCreditParser`: 建行信用卡 (PDF格式) ✅ 已实现
     - `ABCParser`: 农业银行 (PDF格式) ✅ 已实现
     - `SPDBParser`: 浦发信用卡 (PDF格式) ✅ 已实现
     - `CMBParser`: 招商信用卡 (PDF格式) ✅ 已实现
     - `BOCParser`: 宁波银行 (Excel格式)
     - `CITICParser`: 中信银行 (PDF格式) ✅ 已实现
     - `WeChatParser`: 微信支付 (Excel格式) ✅ 已实现
     - `AlipayParser`: 支付宝 (CSV格式) ✅ 已实现
   - 每个解析器实现 `parse()` 方法，将原始文件转换为 `BankStatement` 对象

3. **数据模型**: `src/models.py`
   - `Transaction`: 表示单个交易记录，包含日期、分类、子分类、账户、金额、描述、交易类型(收入/支出/转账)
   - 新增字段：`transfer_to_account`（转账目标账户）、`merchant`（商户名称，用于退款匹配）
   - `BankStatement`: 包含多个交易记录及元数据（如银行名称、账户信息、账单周期）的容器

4. **Excel生成器**: `src/excel_generator.py`
   - 创建随手记兼容格式的xlsx文件（3个Sheet）
   - **支出Sheet**: 交易类型、日期、分类、子分类、支出账户、金额、成员、商家、项目、备注
   - **收入Sheet**: 交易类型、日期、分类、子分类、收入账户、金额、成员、商家、项目、备注
   - **转账Sheet**: 交易类型、日期、转出账户、转入账户、金额、成员、商家、项目、备注

5. **合并处理器**: `src/merge.py`
   - 读取所有Excel文件（支持新旧两种格式）
   - 合并交易记录到统一列表
   - 执行跨文件退款对冲
   - 执行转账识别（储蓄卡→信用卡/支付宝/微信）
   - 输出合并后的Excel文件（3个Sheet格式）

6. **配置文件**:
   - `config/category_mapping.json` - 支出分类映射（两层结构：分类 → 子分类列表）
   - `config/category_mapping_income.json` - 收入分类映射
   - `config/accounts.json` - 账户名称映射

### 分类映射结构

```json
{
  "分类名": ["子分类1", "子分类2", ...]
}
```

支出分类示例：食品酒水、居家物业、行车交通、金融保险等
收入分类示例：职业收入、理财、其他收入等

### 数据流

**第一阶段（main.py）：**
1. 接收输入文件/目录
2. 根据文件扩展名选择合适的解析器
3. 解析器读取原始文件，解析交易记录
4. 根据交易类型（收入/支出）使用对应的分类配置进行自动分类
5. 解析器返回 `BankStatement` 对象
6. Excel生成器创建新工作簿，填充交易数据
7. 最终Excel文件保存到输出目录

**第二阶段（merge.py）：**
1. 读取输出目录下所有Excel文件
2. 合并所有交易记录到统一列表
3. 执行退款对冲（跨文件、跨账户匹配）
4. 执行转账识别（储蓄卡还信用卡）
5. 按日期排序
6. 输出合并后的Excel文件

### 农行PDF解析器特殊规则 (ABCParser)

**收入分类规则：**
- 工资/代发/薪 → 职业收入-工资收入
- 公积金/gjj → 职业收入-公积金转出
- 利息/结息 → 职业收入-利息收入
- 退款/退还 → 其他收入-退款
- 张颖 → 张颖转入-其他

**支出分类规则：**
- 商贷还款（贷款账号`39602057400003997`）→ 金融保险-按揭还款
- 贷款/按揭/房贷 → 金融保险-按揭还款
- 公积金冲还贷（住房公积金 + 代扣/还款）→ 金融保险-按揭还款
- 公积金扣缴（普通公积金）→ 居家物业-五险一金
- 微信 → 账单导入-微信账单导入
- 支付宝 → 账单导入-支付宝账单导入
- 短信费 → 交流通讯-手机费

**注意：** 已分类为"金融保险-按揭还款"的记录不会被merge.py的转账识别逻辑处理，即使描述中包含"还款"关键词。

### 浦发信用卡解析器特殊规则

**交易类型处理：**
| 类型 | 识别规则 | 处理方式 |
|------|----------|----------|
| 消费 | 正金额 | 支出 |
| 还款 | 描述含"还款" | 跳过 |
| 红包抵扣 | 负金额 + "分润金/抵扣" | 收入（抢红包）|
| 退款 | 负金额 + 同商户同金额 | 与消费对冲 |
| 未匹配退款 | 负金额 + 无匹配 | 收入（退款）|

### 建行信用卡解析器特殊规则 (CCBCreditParser)

**PDF格式：**
- 交易明细在 `[人民币账户] RMB Account` 之后
- 格式：`交易日 银行记账日 卡号后四位 交易描述 CNY 金额 CNY 金额`
- 负金额表示还款或退款

**交易类型处理：**
| 类型 | 识别规则 | 处理方式 |
|------|----------|----------|
| 消费 | 正金额 | 支出 |
| 还款 | 负金额 + 描述含"还款" | 跳过 |
| 退款 | 负金额 + 同商户同金额 | 与消费对冲 |
| 未匹配退款 | 负金额 + 无匹配 | 收入（退款）|

**自动分类规则：**
- 饿了么/美团/拉扎斯/三快/盒马 → 食品酒水-早午晚餐
- 滴滴/高德/打车 → 行车交通-打车租车
- 淘宝/天猫/京东 → 购物消费-网购
- 药房/药店/医院 → 医疗保健-药品费
- 汽车/加油 → 行车交通-汽车用品

### 中信银行信用卡解析器规则 (CITICParser)

**PDF格式：**
- 交易明细在 `本期账单明细 CNY交易` 之后
- 格式：`交易日(YYYYMMDD) 记账日(YYYYMMDD) 卡号后四位 交易描述 CNY 金额 CNY 金额`
- 例如：`20251214 20260114 2359 美团 CNY -87.50 CNY -87.50`

**金额规则（重要）：**
| 金额符号 | 含义 | 处理方式 |
|---------|------|----------|
| 正金额 | 消费（增加应还款）| 支出 |
| 负金额 | 返现/退款（减少应还款）| 收入 |

**交易类型处理：**
| 类型 | 识别规则 | 处理方式 |
|------|----------|----------|
| 消费 | 正金额 | 支出 |
| 还款 | 负金额 + 描述含"还款"（但不含"还款日"）| 保留为`__REPAYMENT__`标记，供merge.py匹配转账来源 |
| 返现/优惠 | 负金额（非还款）| 收入（抢红包）|
| 退款 | 正金额 + 退款关键词 | 尝试与同商户消费对冲 |
| 未匹配退款 | 正金额 + 无匹配 | 收入（退款）|

**还款记录处理：**
- 还款记录（负金额 + "还款"关键词）会被保留为特殊标记`__REPAYMENT__`
- 这些记录用于merge.py的转账识别，通过金额+日期匹配来确定储蓄卡转账的目标信用卡
- 匹配成功后，`__REPAYMENT__`记录会被删除
- 未匹配的`__REPAYMENT__`记录也会在最终输出中被清理

**PDF解析特殊处理：**
- 跳过表头行（账单日、Statement、卡号、Trans Date等）
- 跳过余额汇总行（含多个金额的行）
- 跳过以CNY开头的金额片段行
- 跳过含卡号模式的行（如 `6229-19**-****-2359`）
- 描述延续行处理：当跳过非交易行时清空pending_description，避免残留

**自动分类规则：**
- 拉扎斯/美团/饿了么/肯德基/麦当劳/瑞幸/咖啡 → 食品酒水-早午晚餐
- 拼多多/淘宝/天猫/京东 → 居家物业-日常用品
- 母婴/Babycare/童心 → 居家物业-日常用品

### 合并处理器规则 (merge.py)

**退款对冲规则：**
- 第一轮（精确匹配）：同商户 + 同金额（容差±0.01元）
- 第二轮（模糊匹配）：针对脱敏商户名（如`天猫**营`）或人名（如`张颖`）
  - 条件：同金额 + 日期接近（±30天）
- 范围：跨文件、跨账户（合并后的全局交易池）
- 结果：匹配成功的消费和退款都删除

**转账识别规则：**
- 触发条件：储蓄卡支出 + 描述含信用卡关键词
- **排除条件**：已分类为"金融保险-按揭还款"的记录不会被处理
- 关键词映射：
  - "中信" → 中信信用卡
  - "招商" → 招商信用卡
  - "浦发" → 浦发信用卡
  - "建行信用"/"建行卡" → 建行信用卡
  - "花呗" → 花呗
  - "京东白条" → 京东白条
  - "微信"/"零钱" → 微信
  - "支付宝"/"余额宝" → 支付宝
  - "还款"/"跨行还款"/"信用卡还款" → 需要匹配确定目标
- 储蓄卡账户：农业银行、宁波银行、建行储蓄卡、工商储蓄卡、招商储蓄卡、农村信用合作社
- 结果：支出记录转换为转账记录，写入转账Sheet

**转账识别两轮匹配：**
1. **第一轮（有明确目标）**：描述中含有具体银行关键词（如"中信"），直接标记为转账到对应信用卡
2. **第二轮（需要匹配）**：描述中含"跨行还款"/"还款"但无具体银行名
   - 通过金额+日期（±3天）匹配信用卡的`__REPAYMENT__`收入记录
   - 匹配成功：识别为转账到对应信用卡
   - 匹配失败：标记为转账到通用"信用卡"

**转账Sheet输出格式：**
| 交易类型 | 日期 | 转出账户 | 转入账户 | 金额 | 成员 | 商家 | 项目 | 备注 |
|---------|------|---------|---------|------|------|------|------|------|
| 转账 | 2026-01-20 | 农业银行 | 中信信用卡 | 5000 | | | | 原描述 |
| 转账 | 2026-01-29 | 农业银行 | 支付宝 | 800 | | | | 原描述 |

**子分类规则：**
- 目标为支付宝/微信 → 子分类="充值"
- 目标为信用卡/花呗等 → 子分类="还款"

**亲属卡/亲友代付处理：**
- 触发条件：微信"亲属卡交易"或支付宝交易分类="亲友代付"
- 处理逻辑：
  1. 微信/支付宝解析器记录特殊标记（含日期、金额、使用者、银行）
  2. 合并时在银行卡账单中查找相同日期+金额的交易
  3. **匹配成功**：重分类银行卡交易为"其他杂项-{使用者}支出"，删除标记
  4. **未匹配+银行有数据**：删除标记（避免与银行账单重复）
  5. **未匹配+银行无数据**：保留标记作为"其他杂项-{使用者}支出"
- 作用：区分本人消费和亲属消费，避免重复记账
- 注意：支付宝的"交易对方"字段即为使用者姓名（如"张颖"）

### 微信支付解析器规则 (WeChatParser)

**支付方式处理：**
| 支付方式 | 处理方式 |
|---------|----------|
| 零钱/零钱通 | 保留，记入"微信"账户 |
| 银行卡支出 | 跳过（避免与银行账单重复）|
| 银行卡转入零钱通 | 标记为转账 |
| 亲属卡交易 | 记录标记，供merge识别银行卡账单中对应交易 |

**交易类型映射：**
- 商户消费 → 支出
- 微信红包-退款 → 收入（退款）
- 转账（收入）→ 收入
- 转入零钱通-来自XXX银行 → 转账（银行→微信）

**自动分类规则：**
- 红包 → 其他收入-抢红包 / 人情往来-送礼请客
- 退款 → 其他收入-退款
- 食堂/餐 → 食品酒水-早午晚餐
- 停车 → 行车交通-停车费
- 滴滴/出行 → 行车交通-打车租车
- 美团/外卖 → 食品酒水-早午晚餐

### 支付宝解析器规则 (AlipayParser)

**交易状态处理：**
| 交易状态 | 处理方式 |
|---------|----------|
| 交易成功 | 正常处理 |
| 等待确认收货 | 等同交易成功 |
| 还款成功 | 等同交易成功 |
| 交易关闭 | 跳过 |
| 退款成功 | 匹配消费对冲，无匹配则记为收入 |

**支付方式处理：**
| 支付方式 | 处理方式 |
|---------|----------|
| 余额/余额宝/花呗 | 保留，记入"支付宝"账户 |
| 银行卡支出 | 跳过（避免与银行账单重复）|
| 亲友代付 | 记录标记，供merge识别银行卡账单中对应交易 |

**退款处理逻辑：**
1. 收集所有"交易成功"的支出记录（对方+金额）
2. 对于"退款成功"状态的记录：
   - 尝试匹配同对方+同金额的消费
   - 匹配成功：两条记录都删除（对冲）
   - 无匹配：作为收入记录（"其他收入-退款"）

**自动分类规则：**
- 红包 → 其他收入-抢红包 / 人情往来-送礼请客
- 退款 → 其他收入-退款
- 转账 → 其他收入-支付宝转账收入 / 人情往来-送礼请客
- 外卖/饿了么/美团 → 食品酒水-早午晚餐
- 淘宝/天猫 → 购物消费-网购
- 话费/充值 → 交流通讯-手机费
- 电费/水费/燃气 → 居家物业-水电煤
- 还款/信用卡 → 转账-还款
- 余额宝/理财 → 理财-理财收益
- 投资/基金 → 理财-基金投资